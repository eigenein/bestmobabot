(function (h) {
    var response = {"userId":"833061","typeId":"494872","attackers":{"29":{"id":29,"xp":3557580,"level":129,"color":10,"slots":{"1":0,"4":0,"0":0,"2":0,"3":0},"skills":{"145":129,"146":129,"147":129,"148":129},"power":35571,"star":6,"runes":[0,0,50,0,0],"skins":[],"currentSkin":0,"titanGiftLevel":0,"titanCoinsSpent":null,"artifacts":[{"level":49,"star":3},{"level":44,"star":2},{"level":38,"star":1}],"scale":1,"agility":1869,"hp":28865.099999999999,"intelligence":3464,"physicalAttack":106,"strength":2003,"armor":781,"magicPower":3610.8000000000002,"magicResist":747,"skin":0},"13":{"id":13,"xp":3557571,"level":129,"color":10,"slots":{"3":0,"1":0,"2":0,"0":0,"4":0},"skills":{"62":129,"63":129,"64":129,"65":129},"power":42958,"star":6,"runes":[50,0,570,0,50],"skins":{"13":5,"38":36},"currentSkin":38,"titanGiftLevel":0,"titanCoinsSpent":null,"artifacts":[{"level":82,"star":4},{"level":78,"star":2},{"level":79,"star":2}],"scale":1,"agility":1889,"hp":15420,"intelligence":4049.3000000000002,"physicalAttack":50,"strength":2023,"armor":700,"magicPenetration":3613.6999999999998,"magicPower":8871.3999999999996,"magicResist":947,"skin":38},"35":{"id":35,"xp":3557303,"level":129,"color":10,"slots":{"3":0,"1":0,"4":0,"0":0,"2":0},"skills":{"175":129,"176":129,"177":129,"178":129},"power":38720,"star":6,"runes":[0,0,0,0,0],"skins":{"79":21},"currentSkin":79,"titanGiftLevel":0,"titanCoinsSpent":null,"artifacts":[{"level":56,"star":4},{"level":58,"star":3},{"level":69,"star":2}],"scale":1,"agility":1665,"hp":20315,"intelligence":2476,"physicalAttack":50,"strength":3894.3000000000002,"armor":2022.2,"magicPower":1796,"magicResist":3619.1999999999998,"skin":79},"25":{"id":25,"xp":3557591,"level":129,"color":12,"slots":{"3":0,"4":0,"1":0,"2":0},"skills":{"125":129,"126":129,"127":129,"128":129},"power":53327,"star":6,"runes":[9850,1050,6920,1000,1100],"skins":{"25":47},"currentSkin":25,"titanGiftLevel":24,"titanCoinsSpent":{"consumable":{"24":39550}},"artifacts":[{"level":93,"star":4},{"level":92,"star":3},{"level":93,"star":3}],"scale":1,"agility":6511,"hp":10815,"intelligence":1827,"physicalAttack":4993.1999999999998,"strength":2611,"armor":100,"armorPenetration":7221.6000000000004,"magicResist":466,"physicalCritChance":653,"skin":25},"39":{"id":39,"xp":3557555,"level":129,"color":10,"slots":[0,0,0,0],"skills":{"195":129,"196":129,"197":129,"198":129},"power":47884,"star":6,"runes":[490,1420,13970,43750,490],"skins":{"52":3,"82":38},"currentSkin":82,"titanGiftLevel":21,"titanCoinsSpent":{"consumable":{"24":29350}},"artifacts":[{"level":61,"star":5},{"level":61,"star":3},{"level":63,"star":3}],"scale":1,"agility":1790,"hp":60865,"intelligence":1661,"physicalAttack":2035,"strength":5014.1999999999998,"armor":9955.7999999999993,"magicResist":4779.8000000000002,"skin":82}},"defenders":[{"7":{"id":7,"xp":21491,"level":41,"color":6,"slots":{"1":0,"3":0,"0":0,"2":0},"skills":{"32":20,"33":20,"34":26},"power":4719,"star":2,"runes":[0,0,0,0,0],"skins":[],"currentSkin":0,"titanGiftLevel":0,"titanCoinsSpent":null,"artifacts":[{"level":1,"star":0},{"level":1,"star":0},{"level":1,"star":0}],"scale":1,"agility":186,"hp":4085,"intelligence":458,"physicalAttack":78,"strength":191,"armor":342,"magicPower":907,"magicResist":431,"skin":0,"state":{"hp":11725,"energy":0,"isDead":false}},"20":{"id":20,"xp":21541,"level":41,"color":5,"slots":{"3":0,"4":0,"0":0,"2":0,"1":0},"skills":{"97":12,"98":25,"99":23},"power":4215,"star":2,"runes":[0,0,0,0,0],"skins":[],"currentSkin":0,"titanGiftLevel":0,"titanCoinsSpent":null,"artifacts":[{"level":1,"star":0},{"level":1,"star":0},{"level":1,"star":0}],"scale":1,"agility":360,"hp":1200,"intelligence":234,"physicalAttack":599,"strength":188,"armor":100,"armorPenetration":150,"magicResist":192,"physicalCritChance":75,"skin":0,"state":{"hp":8720,"energy":0,"isDead":false}},"9":{"id":9,"xp":21341,"level":41,"color":5,"slots":{"4":0,"0":0,"1":0,"2":0,"3":0},"skills":{"42":25,"43":38,"44":38},"power":4426,"star":1,"runes":[50,0,0,0,0],"skins":[],"currentSkin":0,"titanGiftLevel":0,"titanCoinsSpent":null,"artifacts":[{"level":1,"star":0},{"level":1,"star":0},{"level":1,"star":0}],"scale":1,"agility":160,"hp":1000,"intelligence":308,"physicalAttack":50,"strength":160,"armor":225,"dodge":75,"magicPower":471,"magicResist":217,"skin":0,"state":{"hp":7400,"energy":0,"isDead":false}},"12":{"id":12,"xp":21337,"level":41,"color":5,"slots":{"0":0,"1":0,"3":0,"2":0,"4":0},"skills":{"57":41,"58":41,"59":41},"power":6355,"star":3,"runes":[340,100,0,0,0],"skins":[],"currentSkin":0,"titanGiftLevel":0,"titanCoinsSpent":null,"artifacts":[{"level":1,"star":0},{"level":1,"star":0},{"level":1,"star":0}],"scale":1,"agility":467,"hp":2305,"intelligence":334,"physicalAttack":517,"strength":322,"armor":50,"magicPower":425,"magicResist":134,"skin":0,"state":{"hp":15185,"energy":0,"isDead":false}},"4":{"id":4,"xp":22041,"level":41,"color":6,"slots":{"0":0,"3":0,"1":0,"4":0,"2":0},"skills":{"255":41,"256":32,"257":35},"power":5640,"star":2,"runes":[250,340,0,0,0],"skins":[],"currentSkin":0,"titanGiftLevel":0,"titanCoinsSpent":null,"artifacts":[{"level":1,"star":0},{"level":1,"star":0},{"level":1,"star":0}],"scale":1,"agility":195,"hp":7180,"intelligence":241,"physicalAttack":161,"strength":372,"armor":687,"magicPower":315,"magicResist":555,"skin":0,"state":{"hp":22060,"energy":0,"isDead":false}}}],"effects":[],"reward":{"dungeonActivity":1,"consumable":{"20":25}},"startTime":1550524593,"seed":1295499428,"type":"clan_dungeon","rewardMultiplier":1};

    console.debug('Get classes.');
    var Bytes = h['haxe.io.Bytes']; // `ib`
    var BattleInstantPlay = h['game.battle.controller.instant.BattleInstantPlay']; // `vq`
    var BattlePresets = h['game.battle.controller.thread.BattlePresets']; // `sj`
    var DataStorage = h['game.data.storage.DataStorage'];  // `v`
    var AssetStorage = h['game.assets.storage.AssetStorage']; // `r`
    var BattleAssetStorage = h['game.assets.storage.BattleAssetStorage']; // `sh`
    var BattleLog = h['battle.BattleLog']; // `Ra`

    console.debug('Load skills.sc.');
    AssetStorage.battle = new BattleAssetStorage();
    AssetStorage.battle.loadEncodedCode(new Bytes(Array.from(fs.readFileSync('skills.sc'))));
    
    h.JsPakoCompression.init();
    pako = module.exports;

    console.debug('Init data storage.');
    new DataStorage(JSON.parse(fs.readFileSync('lib.json', 'utf8')));

    console.debug('Init battle instant play.');
    // TODO: pay attention to `get_tower` and `get_titan`.
    var presets = new BattlePresets(false, false, true, DataStorage.battleConfig.get_tower(), false);
    var play = new BattleInstantPlay(response, presets);
    play.battleData.attackers.initialize(AssetStorage.battle.skillFactory.bind(AssetStorage.battle));
    play.battleData.defenders.initialize(AssetStorage.battle.skillFactory.bind(AssetStorage.battle));

    console.debug('Execute battle.');
    play.executeBattle();

    console.debug('Create result.');
    BattleLog.m.bytes.getEncodedString = function() { return this.bytes }; // Avoid infinite loop in Pako.
    play.createResult();
    var result = play.get_result();

    console.log({
        result: result.get_result(),
        progress: result.get_progress(),
    });
})(window.h)
